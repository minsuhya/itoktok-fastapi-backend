# Refactor Plan (Web + Backend, Mobile Excluded)

이 문서는 웹/백엔드 리팩토링의 상세 작업 계획이다.
범위는 기존 합의 사항(권한/인증, 응답 스키마, 웹 라우팅/메뉴 불일치, 데이터 모델 정합성, 검색/필터 공통화, 일정 도메인 모듈화)에 한정한다.

## Scope
### In Scope
- 백엔드 권한/인증 일관화
- API 응답 스키마 통일 및 웹 프론트 정합성
- 웹 라우팅/메뉴 불일치 정리
- 웹 입력 필드/모델 필드 정합성 정리
- 웹 검색/필터 공통화
- 일정(캘린더) 도메인 모듈화

### Out of Scope
- 모바일 앱/모바일 웹 전반 (Expo 신규 구축 예정, 현 코드베이스 제외)
- 신규 기능 추가 (기존 기능 안정화 중심)

## Phase 0: Baseline & Safety
- 코드 기준 버전 고정 및 변경 범위 명세
- 운영 DB 사용 환경에서 영향도 점검
- 테스트 계정/테스트 데이터 목록 정리

## Phase 1: 권한/인증 일관화 (Backend)
### 목표
- 모든 보호된 엔드포인트에 인증/권한 체크 일관 적용
- 역할(센터장/상담사/최고관리자) 기준 데이터 접근 규칙 명확화

### 작업
- `/center/*`, `/teachers/*` 등 인증 의존성이 없는 엔드포인트에 `oauth2_scheme` 및 `get_current_user` 적용
- CRUD 레벨에서 role 기반 필터가 누락된 API 점검 및 보강
- `user_type`, `is_superuser` 기준 필터 로직을 문서화 및 테스트 케이스화

### 산출물
- 권한 매트릭스(역할 x API 접근) 업데이트
- 보안/권한 회귀 테스트 체크리스트

## Phase 2: 응답 스키마/프론트 정합성
### 목표
- API 응답 구조를 단일 패턴으로 통일
- 프론트에서 `response.data` 혼용 제거

### 작업
- 백엔드 응답을 `SuccessResponse` 또는 표준 JSON으로 통일
- 프론트 API 모듈에서 응답 어댑터(단일 변환 위치) 도입
- 웹 뷰에서 데이터 접근 규칙(직접 객체 vs data) 일원화

### 결정 사항
- axios 인터셉터는 `response.data`를 반환하는 구조 유지
- API 모듈은 `unwrapResponseData`로 단일 추출 규칙 적용
- 뷰 레이어는 `response.data` 접근 금지

### 산출물
- 응답 스키마 정의 문서
- API 모듈 공통 어댑터

## Phase 3: 웹 라우팅/메뉴 불일치 정리
### 목표
- 메뉴와 라우팅 구조의 불일치 제거

### 작업
- `/test/*` 개발 라우트의 접근 제한 또는 빌드 제외
- 메뉴에 노출되는 화면만 라우터에 남기거나 명시적 가드 추가
- 실제 사용하지 않는 뷰/라우트 정리

### 산출물
- 라우팅-메뉴 매핑표 업데이트

## Phase 4: 데이터 모델/입력 정합성 (웹)
### 목표
- 폼 입력 필드와 백엔드 스키마의 불일치 제거

### 작업
- `birth_date`/`birthdate`, 주소 필드 등 표준 필드명 확정
- 프론트 유효성 검증 규칙(길이/형식)을 백엔드 스키마와 정렬
- 사용자 ID 길이(4~20자) 일괄 적용 점검

### 산출물
- 필드 매핑 표준 문서
- 공통 유효성 규칙

## Phase 5: 검색/필터 공통화 (웹)
### 목표
- 목록 검색 로직 중복 제거

### 작업
- 클라이언트/사용자/프로그램 검색 컴포넌트 공통화
- 검색 파라미터 규칙 통일 (page/size/search_qry)
- 검색 결과 처리 규칙 통일

### 산출물
- 공통 검색 컴포넌트
- 검색 API 가이드

## Phase 6: 일정 도메인 모듈화 (웹)
### 목표
- 월간/주간 일정 조회 및 등록 로직 분리/정리

### 작업
- 캘린더 조회/가공 로직 유틸 모듈화
- 일정 등록/수정 파라미터 구조 통일
- 상담사 선택 필터 로직 표준화

### 산출물
- 일정 도메인 유틸 모듈
- 일정 관련 API 호출 가이드

## Risks & Mitigation
- 권한 강화로 기존 기능 접근 오류 발생 가능
  - 점진 적용 + 역할별 회귀 테스트
- 응답 스키마 통일 시 프론트 런타임 오류 위험
  - 어댑터 계층으로 단계적 전환
- 운영 DB 대상 변경으로 데이터 불일치 위험
  - 작업 전 백업 확인, 변경 로그 기록

## Verification Plan
- Backend: `poetry run pytest tests` (가능한 범위)
- Web: 주요 화면 스모크 테스트
  - 로그인 → 내정보 → 사용자/내담자 목록 → 프로그램 → 일정
- 역할별 접근 테스트
  - 센터장: 센터 범위 데이터 접근 가능
  - 상담사: 본인 데이터만 접근 가능
  - 최고관리자: 전체 접근 가능

## Acceptance Criteria
- 보호된 모든 API에 인증/권한 적용
- 응답 스키마 단일화 및 프론트 오류 없음
- 메뉴/라우팅 불일치 제거
- 핵심 CRUD 플로우(사용자/내담자/프로그램/일정) 정상 동작
- 역할별 접근 제한이 명확히 동작
